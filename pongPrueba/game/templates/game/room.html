<!-- templates/game/game_room.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pong Game - Room: {{ room_name }}</title>
    <style>
        #pongCanvas {
            background-color: black;
            display: block;
            margin: auto;
        }
    </style>
</head>
<body>
    <div id="game">
        <canvas id="pongCanvas" width="800" height="400"></canvas>
    </div>
    <script>
        const canvas = document.getElementById('pongCanvas');
        const context = canvas.getContext('2d');
        const roomName = "{{ room_name }}";
        const socket = new WebSocket('ws://' + window.location.host + '/ws/game/' + roomName + '/');

        const paddleWidth = 10, paddleHeight = 100;
        const ballSize = 10;

        let player = 'player1';  // or 'player2'
        socket.onopen = function(e) {
            console.log("Connection established!");
        };

        socket.onmessage = function(event) {
            const data = JSON.parse(event.data);
            if (data.type === 'game_update') {
                const gameState = data.game_state;
                updateGame(gameState);
            }
        };

        socket.onclose = function(event) {
            if (event.wasClean) {
                console.log(`Closed cleanly, code=${event.code} reason=${event.reason}`);
            } else {
                console.log('Connection died');
            }
        };

        socket.onerror = function(error) {
            console.error('WebSocket error:', error);
        };

        function drawRect(x, y, width, height, color) {
            context.fillStyle = color;
            context.fillRect(x, y, width, height);
        }

        function drawCircle(x, y, radius, color) {
            context.fillStyle = color;
            context.beginPath();
            context.arc(x, y, radius, 0, Math.PI * 2, true);
            context.closePath();
            context.fill();
        }

        function drawNet() {
            for (let i = 0; i < canvas.height; i += 15) {
                drawRect(canvas.width / 2 - 1, i, 2, 10, 'white');
            }
        }

        function drawScore(player1Score, player2Score) {
            context.fillStyle = 'white';
            context.font = '30px Arial';
            context.textAlign = 'center';
            context.fillText(player1Score, canvas.width / 4, 50);
            context.fillText(player2Score, 3 * canvas.width / 4, 50);
        }

        function drawWinScreen(winner) {
            context.fillStyle = 'white';
            context.font = '30px Arial';
            context.textAlign = 'center';
            context.fillText(winner + " Wins!", canvas.width / 2, canvas.height / 2);
            context.fillText("Click to Restart", canvas.width / 2, canvas.height / 2 + 50);
        }

        function updateGame(gameState) {
            context.clearRect(0, 0, canvas.width, canvas.height);
            drawRect(0, 0, canvas.width, canvas.height, 'black');
            drawNet();
            drawRect(0, gameState.paddle1_position, paddleWidth, paddleHeight, 'white');
            drawRect(canvas.width - paddleWidth, gameState.paddle2_position, paddleWidth, paddleHeight, 'white');
            drawCircle(gameState.ball_position[0], gameState.ball_position[1], ballSize, 'white');
            
            if (!gameState.showing_win_screen) {
                drawScore(gameState.player1_score, gameState.player2_score);
            } else {
                drawWinScreen(gameState.player1_score > gameState.player2_score ? "Player 1" : "Player 2");
            }
        }

        document.addEventListener('keydown', (event) => {
            switch (event.key) {
                case 'w':
                    if (player === 'player1') socket.send(JSON.stringify({'action': 'move_paddle', 'player': 'player1', 'direction': 'up'}));
                    break;
                case 's':
                    if (player === 'player1') socket.send(JSON.stringify({'action': 'move_paddle', 'player': 'player1', 'direction': 'down'}));
                    break;
                case 'ArrowUp':
                    if (player === 'player2') socket.send(JSON.stringify({'action': 'move_paddle', 'player': 'player2', 'direction': 'up'}));
                    break;
                case 'ArrowDown':
                    if (player === 'player2') socket.send(JSON.stringify({'action': 'move_paddle', 'player': 'player2', 'direction': 'down'}));
                    break;
            }
        });

        canvas.addEventListener('click', (event) => {
            socket.send(JSON.stringify({'action': 'restart'}));
        });

        function gameLoop() {
            requestAnimationFrame(gameLoop);
        }

        gameLoop();
    </script>
</body>
</html>
